<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>segger.validation.xenium_explorer &#8212; Segger 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=12dfc556" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <script src="../../../_static/documentation_options.js?v=a1637f0b"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=4ea706d9"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for segger.validation.xenium_explorer</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">ConvexHull</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>


<div class="viewcode-block" id="uint32_to_str">
<a class="viewcode-back" href="../../../api/validation/xenium_explorer/index.html#segger.validation.xenium_explorer.uint32_to_str">[docs]</a>
<span class="k">def</span> <span class="nf">uint32_to_str</span><span class="p">(</span><span class="n">cell_id_uint32</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">dataset_suffix</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a uint32 cell ID to a string format.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    cell_id_uint32 (int): The cell ID in uint32 format.</span>
<span class="sd">    dataset_suffix (int): The dataset suffix to append to the cell ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">    str: The cell ID in string format.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hex_prefix</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">cell_id_uint32</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">hex_to_str_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span>
        <span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">:</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">:</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">:</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span>
        <span class="s1">&#39;8&#39;</span><span class="p">:</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">:</span> <span class="s1">&#39;j&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span>
        <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="s1">&#39;p&#39;</span>
    <span class="p">}</span>
    <span class="n">str_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">hex_to_str_mapping</span><span class="p">[</span><span class="n">char</span><span class="p">]</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">hex_prefix</span><span class="p">])</span>
    <span class="n">cell_id_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">str_prefix</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">dataset_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">cell_id_str</span></div>


<div class="viewcode-block" id="str_to_uint32">
<a class="viewcode-back" href="../../../api/validation/xenium_explorer/index.html#segger.validation.xenium_explorer.str_to_uint32">[docs]</a>
<span class="k">def</span> <span class="nf">str_to_uint32</span><span class="p">(</span><span class="n">cell_id_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a string cell ID back to uint32 format.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    cell_id_str (str): The cell ID in string format.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Tuple[int, int]: The cell ID in uint32 format and the dataset suffix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prefix</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">cell_id_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">str_to_hex_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">:</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span>
        <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="s1">&#39;f&#39;</span>
    <span class="p">}</span>
    <span class="n">hex_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">str_to_hex_mapping</span><span class="p">[</span><span class="n">char</span><span class="p">]</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">prefix</span><span class="p">])</span>
    <span class="n">cell_id_uint32</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hex_prefix</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">dataset_suffix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cell_id_uint32</span><span class="p">,</span> <span class="n">dataset_suffix</span></div>


<div class="viewcode-block" id="get_indices_indptr">
<a class="viewcode-back" href="../../../api/validation/xenium_explorer/index.html#segger.validation.xenium_explorer.get_indices_indptr">[docs]</a>
<span class="k">def</span> <span class="nf">get_indices_indptr</span><span class="p">(</span><span class="n">input_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the indices and indptr arrays for sparse matrix representation.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    input_array (np.ndarray): The input array containing cluster labels.</span>

<span class="sd">    Returns:</span>
<span class="sd">    Tuple[np.ndarray, np.ndarray]: The indices and indptr arrays.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">input_array</span><span class="p">[</span><span class="n">input_array</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="n">indptr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
        <span class="n">cluster_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">input_array</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">indptr</span><span class="p">[</span><span class="n">cluster</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">indices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cluster_indices</span><span class="p">)</span>

    <span class="n">indices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_array</span><span class="p">[</span><span class="n">input_array</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])))</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">indices</span><span class="p">,</span> <span class="n">indptr</span></div>


<div class="viewcode-block" id="save_cell_clustering">
<a class="viewcode-back" href="../../../api/validation/xenium_explorer/index.html#segger.validation.xenium_explorer.save_cell_clustering">[docs]</a>
<span class="k">def</span> <span class="nf">save_cell_clustering</span><span class="p">(</span><span class="n">merged</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">zarr_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save cell clustering information to a Zarr file.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    merged (pd.DataFrame): The merged dataframe containing cell clustering information.</span>
<span class="sd">    zarr_path (str): The path to the Zarr file.</span>
<span class="sd">    columns (List[str]): The list of columns to save.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">zarr</span>

    <span class="n">new_zarr</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">zarr_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">new_zarr</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/cell_groups&#39;</span><span class="p">)</span>

    <span class="n">mappings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">new_zarr</span><span class="p">[</span><span class="s1">&#39;cell_groups&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)))</span>
        <span class="n">mapping_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)),</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">classes</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;nan&#39;</span><span class="p">])}</span>
        <span class="n">mapping_dict</span><span class="p">[</span><span class="s1">&#39;nan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">clusters</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">mapping_dict</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">indices</span><span class="p">,</span> <span class="n">indptr</span> <span class="o">=</span> <span class="n">get_indices_indptr</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>

        <span class="n">new_zarr</span><span class="p">[</span><span class="s1">&#39;cell_groups&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;indices&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">new_zarr</span><span class="p">[</span><span class="s1">&#39;cell_groups&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;indptr&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">indptr</span><span class="p">)</span>
        <span class="n">mappings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapping_dict</span><span class="p">)</span>

    <span class="n">new_zarr</span><span class="p">[</span><span class="s1">&#39;cell_groups&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;major_version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;minor_version&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;number_groupings&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">),</span>
        <span class="s2">&quot;grouping_names&quot;</span><span class="p">:</span> <span class="n">columns</span><span class="p">,</span>
        <span class="s2">&quot;group_names&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mapping_dict</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">mapping_dict</span> <span class="ow">in</span> <span class="n">mappings</span>
        <span class="p">]</span>
    <span class="p">})</span>
    <span class="n">new_zarr</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="draw_umap">
<a class="viewcode-back" href="../../../api/validation/xenium_explorer/index.html#segger.validation.xenium_explorer.draw_umap">[docs]</a>
<span class="k">def</span> <span class="nf">draw_umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;leiden&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw UMAP plots for the given AnnData object.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    adata (AnnData): The AnnData object containing the data.</span>
<span class="sd">    column (str): The column to color the UMAP plot by.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;KRT5&#39;</span><span class="p">,</span> <span class="s1">&#39;KRT7&#39;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="s1">&#39;p95&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ACTA2&#39;</span><span class="p">,</span> <span class="s1">&#39;PTPRC&#39;</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="s1">&#39;p95&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_leiden_umap">
<a class="viewcode-back" href="../../../api/validation/xenium_explorer/index.html#segger.validation.xenium_explorer.get_leiden_umap">[docs]</a>
<span class="k">def</span> <span class="nf">get_leiden_umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">draw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform Leiden clustering and UMAP visualization on the given AnnData object.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    adata (AnnData): The AnnData object containing the data.</span>
<span class="sd">    draw (bool): Whether to draw the UMAP plots.</span>

<span class="sd">    Returns:</span>
<span class="sd">    AnnData: The AnnData object with Leiden clustering and UMAP results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">filter_cells</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">min_genes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">filter_genes</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">min_cells</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">gene_names</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span>
    <span class="n">mean_expression_values</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">gene_mean_expression_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;gene_name&#39;</span><span class="p">:</span> <span class="n">gene_names</span><span class="p">,</span>
        <span class="s1">&#39;mean_expression&#39;</span><span class="p">:</span> <span class="n">mean_expression_values</span>
    <span class="p">})</span>
    <span class="n">top_genes</span> <span class="o">=</span> <span class="n">gene_mean_expression_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;mean_expression&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">top_gene_names</span> <span class="o">=</span> <span class="n">top_genes</span><span class="p">[</span><span class="s1">&#39;gene_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_pcs</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">leiden</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
        <span class="n">draw_umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="s1">&#39;leiden&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">adata</span></div>


<div class="viewcode-block" id="get_median_expression_table">
<a class="viewcode-back" href="../../../api/validation/xenium_explorer/index.html#segger.validation.xenium_explorer.get_median_expression_table">[docs]</a>
<span class="k">def</span> <span class="nf">get_median_expression_table</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;leiden&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the median expression table for the given AnnData object.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    adata (AnnData): The AnnData object containing the data.</span>
<span class="sd">    column (str): The column to group by.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pd.DataFrame: The median expression table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">top_genes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GATA3&#39;</span><span class="p">,</span> <span class="s1">&#39;ACTA2&#39;</span><span class="p">,</span> <span class="s1">&#39;KRT7&#39;</span><span class="p">,</span> <span class="s1">&#39;KRT8&#39;</span><span class="p">,</span> <span class="s1">&#39;KRT5&#39;</span><span class="p">,</span> <span class="s1">&#39;AQP1&#39;</span><span class="p">,</span> <span class="s1">&#39;SERPINA3&#39;</span><span class="p">,</span> <span class="s1">&#39;PTGDS&#39;</span><span class="p">,</span> <span class="s1">&#39;CXCR4&#39;</span><span class="p">,</span> <span class="s1">&#39;SFRP1&#39;</span><span class="p">,</span> <span class="s1">&#39;ENAH&#39;</span><span class="p">,</span> <span class="s1">&#39;MYH11&#39;</span><span class="p">,</span> <span class="s1">&#39;SVIL&#39;</span><span class="p">,</span> <span class="s1">&#39;KRT14&#39;</span><span class="p">,</span> <span class="s1">&#39;CD4&#39;</span><span class="p">]</span>
    <span class="n">top_gene_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">top_genes</span><span class="p">]</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
    <span class="n">cluster_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">cluster_cells</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">clusters</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">]</span><span class="o">.</span><span class="n">X</span>
        <span class="n">cluster_expression</span> <span class="o">=</span> <span class="n">cluster_cells</span><span class="p">[:,</span> <span class="n">top_gene_indices</span><span class="p">]</span>
        <span class="n">gene_medians</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">cluster_expression</span><span class="p">[:,</span> <span class="n">gene_idx</span><span class="p">])</span><span class="o">.</span><span class="n">median</span><span class="p">()</span> <span class="k">for</span> <span class="n">gene_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">top_gene_indices</span><span class="p">))]</span>
        <span class="n">cluster_data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Cluster_</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_medians</span>

    <span class="n">cluster_expression_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">top_genes</span><span class="p">)</span>
    <span class="n">sorted_columns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cluster_expression_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">cluster_expression_df</span> <span class="o">=</span> <span class="n">cluster_expression_df</span><span class="p">[</span><span class="n">sorted_columns</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cluster_expression_df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">background_gradient</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greens&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="seg2explorer">
<a class="viewcode-back" href="../../../api/validation/xenium_explorer/index.html#segger.validation.xenium_explorer.seg2explorer">[docs]</a>
<span class="k">def</span> <span class="nf">seg2explorer</span><span class="p">(</span>
    <span class="n">seg_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
    <span class="n">source_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
    <span class="n">cells_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;seg_cells&#39;</span><span class="p">,</span> 
    <span class="n">analysis_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;seg_analysis&quot;</span><span class="p">,</span> 
    <span class="n">xenium_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;seg_experiment.xenium&quot;</span><span class="p">,</span>
    <span class="n">analysis_df</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">draw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
    <span class="n">cell_id_columns</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;seg_cell_id&#39;</span><span class="p">,</span>
    <span class="n">area_low</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">area_high</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert seg output to a format compatible with Xenium explorer.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    seg_df (pd.DataFrame): The seg DataFrame.</span>
<span class="sd">    source_path (str): The source path.</span>
<span class="sd">    output_dir (str): The output directory.</span>
<span class="sd">    cells_filename (str): The filename for cells.</span>
<span class="sd">    analysis_filename (str): The filename for analysis.</span>
<span class="sd">    xenium_filename (str): The filename for Xenium.</span>
<span class="sd">    analysis_df (Optional[pd.DataFrame]): The analysis DataFrame.</span>
<span class="sd">    draw (bool): Whether to draw the plots.</span>
<span class="sd">    cell_id_columns (str): The cell ID columns.</span>
<span class="sd">    area_low (float): The lower area threshold.</span>
<span class="sd">    area_high (float): The upper area threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">zarr</span>
    <span class="kn">import</span> <span class="nn">json</span>

    <span class="n">source_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
    <span class="n">storage</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="n">cell_id2old_id</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cell_id</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cell_summary</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">polygon_num_vertices</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
    <span class="n">polygon_vertices</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
    <span class="n">seg_mask_value</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tma_id</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">grouped_by</span> <span class="o">=</span> <span class="n">seg_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">cell_id_columns</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cell_incremental_id</span><span class="p">,</span> <span class="p">(</span><span class="n">seg_cell_id</span><span class="p">,</span> <span class="n">seg_cell</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">grouped_by</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">grouped_by</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg_cell</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="n">cell_convex_hull</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">seg_cell</span><span class="p">[[</span><span class="s1">&#39;x_location&#39;</span><span class="p">,</span> <span class="s1">&#39;y_location&#39;</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">cell_convex_hull</span><span class="o">.</span><span class="n">area</span> <span class="o">&gt;</span> <span class="n">area_high</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">cell_convex_hull</span><span class="o">.</span><span class="n">area</span> <span class="o">&lt;</span> <span class="n">area_low</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">uint_cell_id</span> <span class="o">=</span> <span class="n">cell_incremental_id</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">cell_id2old_id</span><span class="p">[</span><span class="n">uint_cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_cell_id</span>

        <span class="n">seg_nucleous</span> <span class="o">=</span> <span class="n">seg_cell</span><span class="p">[</span><span class="n">seg_cell</span><span class="p">[</span><span class="s1">&#39;overlaps_nucleus&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg_nucleous</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">nucleus_convex_hull</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">seg_nucleous</span><span class="p">[[</span><span class="s1">&#39;x_location&#39;</span><span class="p">,</span> <span class="s1">&#39;y_location&#39;</span><span class="p">]])</span>

        <span class="n">cell_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uint_cell_id</span><span class="p">)</span>
        <span class="n">cell_summary</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;cell_centroid_x&quot;</span><span class="p">:</span> <span class="n">seg_cell</span><span class="p">[</span><span class="s1">&#39;x_location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s2">&quot;cell_centroid_y&quot;</span><span class="p">:</span> <span class="n">seg_cell</span><span class="p">[</span><span class="s1">&#39;y_location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s2">&quot;cell_area&quot;</span><span class="p">:</span> <span class="n">cell_convex_hull</span><span class="o">.</span><span class="n">area</span><span class="p">,</span>
            <span class="s2">&quot;nucleus_centroid_x&quot;</span><span class="p">:</span> <span class="n">seg_cell</span><span class="p">[</span><span class="s1">&#39;x_location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s2">&quot;nucleus_centroid_y&quot;</span><span class="p">:</span> <span class="n">seg_cell</span><span class="p">[</span><span class="s1">&#39;y_location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s2">&quot;nucleus_area&quot;</span><span class="p">:</span> <span class="n">cell_convex_hull</span><span class="o">.</span><span class="n">area</span><span class="p">,</span>
            <span class="s2">&quot;z_level&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">seg_cell</span><span class="o">.</span><span class="n">z_location</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">//</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>        
        <span class="p">})</span>

        <span class="n">polygon_num_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_convex_hull</span><span class="o">.</span><span class="n">vertices</span><span class="p">))</span> 
        <span class="n">polygon_num_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nucleus_convex_hull</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg_nucleous</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">polygon_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg_cell</span><span class="p">[[</span><span class="s1">&#39;x_location&#39;</span><span class="p">,</span> <span class="s1">&#39;y_location&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">cell_convex_hull</span><span class="o">.</span><span class="n">vertices</span><span class="p">])</span>
        <span class="n">polygon_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg_nucleous</span><span class="p">[[</span><span class="s1">&#39;x_location&#39;</span><span class="p">,</span> <span class="s1">&#39;y_location&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nucleus_convex_hull</span><span class="o">.</span><span class="n">vertices</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg_nucleous</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[],</span> <span class="p">[]])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">seg_mask_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_incremental_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">cell_polygon_vertices</span> <span class="o">=</span> <span class="n">get_flatten_version</span><span class="p">(</span><span class="n">polygon_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>
    <span class="n">nucl_polygon_vertices</span> <span class="o">=</span> <span class="n">get_flatten_version</span><span class="p">(</span><span class="n">polygon_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>

    <span class="n">cells</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_id</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_id</span><span class="p">))],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
        <span class="s2">&quot;cell_summary&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cell_summary</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="s2">&quot;polygon_num_vertices&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">polygon_num_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> 
            <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">polygon_num_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="s2">&quot;polygon_vertices&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nucl_polygon_vertices</span><span class="p">,</span> <span class="n">cell_polygon_vertices</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="s2">&quot;seg_mask_value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">seg_mask_value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="n">existing_store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">source_path</span> <span class="o">/</span> <span class="s1">&#39;cells.zarr.zip&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">new_store</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">storage</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cells_filename</span><span class="si">}</span><span class="s1">.zarr.zip&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

    <span class="n">new_store</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span>
    <span class="n">new_store</span><span class="p">[</span><span class="s1">&#39;polygon_num_vertices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="s1">&#39;polygon_num_vertices&#39;</span><span class="p">]</span>
    <span class="n">new_store</span><span class="p">[</span><span class="s1">&#39;polygon_vertices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="s1">&#39;polygon_vertices&#39;</span><span class="p">]</span>
    <span class="n">new_store</span><span class="p">[</span><span class="s1">&#39;seg_mask_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="s1">&#39;seg_mask_value&#39;</span><span class="p">]</span>
    
    <span class="n">new_store</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">existing_store</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
    <span class="n">new_store</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;number_cells&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">])</span>
    <span class="n">new_store</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">analysis_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">analysis_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cell_id2old_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cell_id</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">cell_id_columns</span><span class="p">])</span>
        <span class="n">analysis_df</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;seg&#39;</span>
    
    <span class="n">zarr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cell_id2old_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cell_id</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">cell_id_columns</span><span class="p">])</span>
    <span class="n">clustering_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">zarr_df</span><span class="p">,</span> <span class="n">analysis_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">cell_id_columns</span><span class="p">)</span>

    <span class="n">clusters_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">analysis_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">cell_id_columns</span><span class="p">]</span>
    <span class="n">clusters_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">cluster</span><span class="p">:</span> <span class="p">{</span><span class="n">j</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clustering_df</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clustering_df</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">())))}</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters_names</span><span class="p">}</span>

    <span class="n">new_zarr</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">storage</span> <span class="o">/</span> <span class="p">(</span><span class="n">analysis_filename</span> <span class="o">+</span> <span class="s2">&quot;.zarr.zip&quot;</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">new_zarr</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/cell_groups&#39;</span><span class="p">)</span>

    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[[</span><span class="n">clusters_dict</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">clustering_df</span><span class="p">[</span><span class="n">cluster</span><span class="p">])]</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters_names</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)):</span>
        <span class="n">new_zarr</span><span class="p">[</span><span class="s1">&#39;cell_groups&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">indices</span><span class="p">,</span> <span class="n">indptr</span> <span class="o">=</span> <span class="n">get_indices_indptr</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">new_zarr</span><span class="p">[</span><span class="s1">&#39;cell_groups&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;indices&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">new_zarr</span><span class="p">[</span><span class="s1">&#39;cell_groups&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;indptr&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">indptr</span><span class="p">)</span>

    <span class="n">new_zarr</span><span class="p">[</span><span class="s1">&#39;cell_groups&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;major_version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;minor_version&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;number_groupings&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters_names</span><span class="p">),</span>
        <span class="s2">&quot;grouping_names&quot;</span><span class="p">:</span> <span class="n">clusters_names</span><span class="p">,</span>
        <span class="s2">&quot;group_names&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">clusters_dict</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">clusters_names</span>
        <span class="p">]</span>
    <span class="p">})</span>

    <span class="n">new_zarr</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">generate_experiment_file</span><span class="p">(</span>
        <span class="n">template_path</span><span class="o">=</span><span class="n">source_path</span> <span class="o">/</span> <span class="s1">&#39;experiment.xenium&#39;</span><span class="p">,</span>
        <span class="n">output_path</span><span class="o">=</span><span class="n">storage</span> <span class="o">/</span> <span class="n">xenium_filename</span><span class="p">,</span>
        <span class="n">cells_name</span><span class="o">=</span><span class="n">cells_filename</span><span class="p">,</span>
        <span class="n">analysis_name</span><span class="o">=</span><span class="n">analysis_filename</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="get_flatten_version">
<a class="viewcode-back" href="../../../api/validation/xenium_explorer/index.html#segger.validation.xenium_explorer.get_flatten_version">[docs]</a>
<span class="k">def</span> <span class="nf">get_flatten_version</span><span class="p">(</span><span class="n">polygons</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">max_value</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the flattened version of polygon vertices.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    polygons (List[np.ndarray]): List of polygon vertices.</span>
<span class="sd">    max_value (int): The maximum number of vertices to keep.</span>

<span class="sd">    Returns:</span>
<span class="sd">    np.ndarray: The flattened array of polygon vertices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">max_value</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">polygons</span><span class="p">),</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">polygon</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">polygons</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">polygons</span><span class="p">)):</span>
        <span class="n">num_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_points</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">elif</span> <span class="n">num_points</span> <span class="o">&lt;</span> <span class="n">max_value</span><span class="p">:</span>
            <span class="n">repeated_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">polygon</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">num_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">padded_polygon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">polygon</span><span class="p">,</span> <span class="n">repeated_points</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">padded_polygon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">padded_polygon</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">n</span><span class="p">)]</span> <span class="o">=</span> <span class="n">polygon</span><span class="p">[:</span><span class="nb">min</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">n</span><span class="p">)]</span>
            <span class="n">padded_polygon</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">polygon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">padded_polygon</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="generate_experiment_file">
<a class="viewcode-back" href="../../../api/validation/xenium_explorer/index.html#segger.validation.xenium_explorer.generate_experiment_file">[docs]</a>
<span class="k">def</span> <span class="nf">generate_experiment_file</span><span class="p">(</span>
    <span class="n">template_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">cells_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;seg_cells&quot;</span><span class="p">,</span>
    <span class="n">analysis_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;seg_analysis&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the experiment file for Xenium.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    template_path (str): The path to the template file.</span>
<span class="sd">    output_path (str): The path to the output file.</span>
<span class="sd">    cells_name (str): The name of the cells file.</span>
<span class="sd">    analysis_name (str): The name of the analysis file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">json</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;morphology_filepath&#39;</span><span class="p">)</span>
    <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;morphology_focus_filepath&#39;</span><span class="p">)</span>

    <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;xenium_explorer_files&#39;</span><span class="p">][</span><span class="s1">&#39;cells_zarr_filepath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cells_name</span><span class="si">}</span><span class="s2">.zarr.zip&quot;</span>
    <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;xenium_explorer_files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cell_features_zarr_filepath&#39;</span><span class="p">)</span>
    <span class="n">experiment</span><span class="p">[</span><span class="s1">&#39;xenium_explorer_files&#39;</span><span class="p">][</span><span class="s1">&#39;analysis_zarr_filepath&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">analysis_name</span><span class="si">}</span><span class="s2">.zarr.zip&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Segger</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.0.2</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>